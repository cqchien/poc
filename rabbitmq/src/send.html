<!DOCTYPE html>
<html>
  <head>
    <title>RabbitMQ AMQP Client Example</title>
  </head>
  <body>
    <h1>RabbitMQ AMQP Client</h1>
    <body>
      <form>
        <textarea id="textarea" rows=10></textarea>
        <br/>
        <input id="message"/>
        <button type="submit">Send</button>
      </form>
    </body>
    <script type="module">
      import { AMQPWebSocketClient } from "https://cdn.jsdelivr.net/npm/@cloudamqp/amqp-client@3.1.1/dist/amqp-websocket-client.mjs";
      // import { AMQPWebSocketClient } from './amqp-websocket-client.mjs'

      const textarea = document.getElementById("textarea")
      const input = document.getElementById("message")

      // const url = "ws://localhost:15675/ws"; // RabbitMQ WebSocket URL
      const url = "ws://localhost:15670/ws/amqp"; // RabbitMQ WebSocket URL
      const amqp = new AMQPWebSocketClient(url, "/", "admin", "admin");

      async function start() {
        try {
          const conn = await amqp.connect();
          const ch = await conn.channel();
          const queue = "test-queue";
          await ch.queueDeclare(queue);

          // Publish a message
          const message = "Hello, RabbitMQ!";
          await ch.basicPublish(
            "",
            queue,
            new TextEncoder().encode(message),
          );
          console.log(`Sent: ${message}`);


          // attachPublish(ch);
          // const q = await ch.queue("");
          // await q.bind("amq.fanout");
          // const consumer = await q.subscribe({ noAck: false }, (msg) => {
          //   console.log(msg);
          //   textarea.value += msg.bodyToString() + "\n";
          //   msg.ack();
          // });
        } catch (err) {
          console.error("Error", err, "reconnecting in 1s");
          // disablePublish();
          // setTimeout(start, 1000);
        }
      }

      function attachPublish(ch) {
        document.forms[0].onsubmit = async (e) => {
          e.preventDefault();
          try {
            await ch.basicPublish("amq.fanout", "", input.value, {
              contentType: "text/plain",
            });
          } catch (err) {
            console.error("Error", err, "reconnecting in 1s");
            disablePublish();
            setTimeout(start, 1000);
          }
          input.value = "";
        };
      }

      function disablePublish() {
        document.forms[0].onsubmit = (e) => {
          alert("Disconnected, waiting to be reconnected");
        };
      }

      start();
    </script>
  </body>
</html>
